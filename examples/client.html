<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Matching Engine Client (DEBUG)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #764ba2;
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-panel {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        .debug-panel h3 {
            margin-top: 0;
            color: #721c24;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }
        .panel h2 {
            margin-top: 0;
            color: #495057;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 5px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #orderBook {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .bid-levels, .ask-levels {
            max-height: 300px;
            overflow-y: auto;
        }
        .price-level {
            display: flex;
            justify-content: space-between;
            padding: 2px 5px;
            margin: 1px 0;
            font-size: 12px;
        }
        .bid-levels .price-level {
            background: rgba(34, 139, 34, 0.1);
        }
        .ask-levels .price-level {
            background: rgba(220, 20, 60, 0.1);
        }
        #trades, #messages {
            height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
        }
        .trade-item {
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connected {
            background: #28a745;
        }
        .disconnected {
            background: #dc3545;
        }
        .bbo-display {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .bbo-item {
            text-align: center;
        }
        .bbo-label {
            font-size: 12px;
            color: #6c757d;
        }
        .bbo-value {
            font-size: 18px;
            font-weight: bold;
        }
        .bid-value {
            color: #28a745;
        }
        .ask-value {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Crypto Matching Engine Client (DEBUG MODE)</h1>
        
        <div class="debug-panel">
            <h3>üêõ Debug Console</h3>
            <div id="debugConsole">Initializing...</div>
        </div>
        
        <div class="grid">
            <div class="panel">
                <h2>Order Entry</h2>
                <div id="connectionStatus">
                    <span class="status-indicator disconnected"></span>
                    <span id="statusText">Disconnected</span>
                </div>
                
                <div class="form-group">
                    <label>Symbol</label>
                    <select id="symbolSelect" onchange="changeSymbol()">
                        <option>BTC-USDT</option>
                        <option>ETH-USDT</option>
                        <option>SOL-USDT</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Side</label>
                    <select id="side">
                        <option value="buy">Buy</option>
                        <option value="sell">Sell</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Order Type</label>
                    <select id="orderType" onchange="togglePriceField()">
                        <option value="limit">Limit</option>
                        <option value="market">Market</option>
                        <option value="ioc">IOC</option>
                        <option value="fok">FOK</option>
                    </select>
                </div>
                
                <div class="form-group" id="priceGroup">
                    <label>Price</label>
                    <input type="number" id="price" step="0.01" placeholder="50000.00">
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" step="0.001" placeholder="1.000">
                </div>
                
                <button onclick="submitOrder()" id="submitBtn" disabled>Submit Order</button>
                
                <hr style="margin: 15px 0;">
                
                <div class="form-group">
                    <label>Cancel Order ID</label>
                    <input type="text" id="cancelOrderId" placeholder="Enter Order ID">
                    <button onclick="cancelOrder()">Cancel Order</button>
                </div>
            </div>
            
            <div class="panel">
                <h2>Order Book - <span id="currentSymbol">BTC-USDT</span></h2>
                <div class="bbo-display">
                    <div class="bbo-item">
                        <div class="bbo-label">Best Bid</div>
                        <div class="bbo-value bid-value" id="bestBid">-</div>
                    </div>
                    <div class="bbo-item">
                        <div class="bbo-label">Spread</div>
                        <div class="bbo-value" id="spread">-</div>
                    </div>
                    <div class="bbo-item">
                        <div class="bbo-label">Best Ask</div>
                        <div class="bbo-value ask-value" id="bestAsk">-</div>
                    </div>
                </div>
                <div id="orderBook">
                    <div>
                        <h3 style="color: #28a745; font-size: 14px;">Bids</h3>
                        <div class="bid-levels" id="bids"></div>
                    </div>
                    <div>
                        <h3 style="color: #dc3545; font-size: 14px;">Asks</h3>
                        <div class="ask-levels" id="asks"></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2>Recent Trades</h2>
                <div id="trades"></div>
            </div>
        </div>
        
        <div class="panel">
            <h2>System Messages</h2>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let ws = null;
        const clientId = 'client-' + Math.random().toString(36).substr(2, 9);
        let currentSymbol = 'BTC-USDT';
        let reconnectAttempts = 0;
        let isReconnecting = false;
        
        // Debug logging
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const debugEl = document.getElementById('debugConsole');
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += `\n${JSON.stringify(data, null, 2)}`;
            }
            console.log(logEntry);
            debugEl.textContent = logEntry + '\n\n' + debugEl.textContent;
            
            // Keep only last 1000 chars
            if (debugEl.textContent.length > 1000) {
                debugEl.textContent = debugEl.textContent.substring(0, 1000);
            }
        }
        
        function connect() {
            if (isReconnecting) {
                debugLog('‚ö†Ô∏è Already reconnecting, skipping...');
                return;
            }
            
            isReconnecting = true;
            reconnectAttempts++;
            
            const wsUrl = `ws://localhost:8000/ws/${clientId}`;
            debugLog(`üîå Connect attempt #${reconnectAttempts}`, { url: wsUrl });
            addMessage(`üîå Connecting to ${wsUrl}... (attempt ${reconnectAttempts})`);
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    debugLog('‚úÖ WebSocket OPENED');
                    addMessage('‚úÖ Connected to matching engine');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    isReconnecting = false;
                };
                
                ws.onmessage = (event) => {
                    debugLog('üì® Message received', { length: event.data.length });
                    try {
                        const parsed = JSON.parse(event.data);
                        const messages = Array.isArray(parsed) ? parsed : [parsed];
                        messages.forEach((data) => {
                            debugLog(`üì¨ Parsed: ${data.type || 'list-item'}`, data);
                            handleMessage(data);
                        });
                    } catch (e) {
                        debugLog('‚ùå Parse error', { error: e.message, data: event.data });
                        console.error('Failed to parse message:', e, event.data);
                    }
                };
                
                ws.onerror = (error) => {
                    debugLog('‚ùå WebSocket ERROR', { error: error });
                    console.error('WebSocket error:', error);
                    addMessage('‚ùå WebSocket error occurred');
                };
                
                ws.onclose = (event) => {
                    debugLog('üîå WebSocket CLOSED', { 
                        code: event.code, 
                        reason: event.reason,
                        wasClean: event.wasClean 
                    });
                    addMessage(`üîå Disconnected (code: ${event.code}, reason: ${event.reason || 'none'})`);
                    updateConnectionStatus(false);
                    isReconnecting = false;
                    
                    // Auto-reconnect
                    setTimeout(() => {
                        debugLog('‚è∞ Reconnect timer triggered');
                        connect();
                    }, 5000);
                };
            } catch (e) {
                debugLog('‚ùå WebSocket creation failed', { error: e.message });
                isReconnecting = false;
                setTimeout(connect, 5000);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusText = document.getElementById('statusText');
            const indicator = document.querySelector('.status-indicator');
            const submitBtn = document.getElementById('submitBtn');
            
            if (connected) {
                statusText.textContent = 'Connected';
                indicator.className = 'status-indicator connected';
                submitBtn.disabled = false;
            } else {
                statusText.textContent = 'Disconnected';
                indicator.className = 'status-indicator disconnected';
                submitBtn.disabled = true;
            }
        }
        
        function handleMessage(data) {
            const msgType = data.type || 'unknown';
            debugLog(`üéØ Handling: ${msgType}`);
            
            switch(msgType) {
                case 'connection':
                    handleConnection(data);
                    break;
                case 'subscription_response':
                    handleSubscriptionResponse(data);
                    break;
                case 'market_data':
                    updateOrderBook(data);
                    break;
                case 'trade':
                    addTrade(data);
                    break;
                case 'order_response':
                    handleOrderResponse(data);
                    break;
                case 'cancel_response':
                    handleCancelResponse(data);
                    break;
                case 'error':
                    debugLog('‚ö†Ô∏è Server error', data);
                    addMessage(`‚ùå Error: ${data.message}`);
                    break;
                case 'pong':
                    debugLog('üèì Pong received');
                    break;
                default:
                    debugLog('‚ùì Unknown message type', data);
                    console.log('Unknown message type:', msgType, data);
            }
        }
        
        function handleConnection(data) {
            debugLog('‚úÖ Connection established', data);
            addMessage(`‚úÖ Connected as ${data.client_id}`);
            addMessage(`üìä Available symbols: ${data.available_symbols?.join(', ')}`);
            subscribeToSymbol(currentSymbol);
        }
        
        function subscribeToSymbol(symbol) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                debugLog('‚ö†Ô∏è Cannot subscribe: not connected', { readyState: ws?.readyState });
                addMessage('‚ö†Ô∏è Cannot subscribe: not connected');
                return;
            }
            
            debugLog(`üì° Subscribing to ${symbol}`);
            addMessage(`üì° Subscribing to ${symbol}...`);
            
            const msg = {
                type: 'subscribe',
                symbols: [symbol],
                trades: true,
                market_data: true
            };
            
            debugLog('üì§ Sending subscribe', msg);
            ws.send(JSON.stringify(msg));
        }
        
        function handleSubscriptionResponse(data) {
            debugLog('‚úÖ Subscription response', data);
            const subscribed = data.subscribed || [];
            if (subscribed.length > 0) {
                addMessage(`‚úÖ Subscribed to: ${subscribed.join(', ')}`);
            } else {
                addMessage(`‚ö†Ô∏è ${data.message || 'Subscription failed'}`);
            }
        }
        
        function updateOrderBook(data) {
            debugLog('üìä Updating order book', { symbol: data.symbol });
            
            if (data.symbol && data.symbol !== currentSymbol) {
                debugLog(`‚ö†Ô∏è Symbol mismatch: ${data.symbol} vs ${currentSymbol}`);
                return;
            }
            
            if (data.bbo) {
                const bbo = data.bbo;
                const bestBid = bbo.best_bid;
                const bestAsk = bbo.best_ask;
                
                setText('bestBid', bestBid ? formatPrice(bestBid.price) : '-');
                setText('bestAsk', bestAsk ? formatPrice(bestAsk.price) : '-');
                setText('spread', bbo.spread != null ? formatPrice(bbo.spread) : '-');
            }
            
            if (data.depth) {
                updateDepth(data.depth);
            }
        }
        
        function updateDepth(depth) {
            const bidsEl = document.getElementById('bids');
            const asksEl = document.getElementById('asks');
            
            bidsEl.innerHTML = '';
            asksEl.innerHTML = '';
            
            const bids = depth.bids || [];
            bids.forEach(([price, qty]) => {
                const el = document.createElement('div');
                el.className = 'price-level';
                el.innerHTML = `<span>${formatQty(qty)}</span><span>${formatPrice(price)}</span>`;
                bidsEl.appendChild(el);
            });
            
            const asks = depth.asks || [];
            asks.forEach(([price, qty]) => {
                const el = document.createElement('div');
                el.className = 'price-level';
                el.innerHTML = `<span>${formatPrice(price)}</span><span>${formatQty(qty)}</span>`;
                asksEl.appendChild(el);
            });
            
            debugLog(`üìä Depth updated: ${bids.length} bids, ${asks.length} asks`);
        }
        
        function addTrade(data) {
            debugLog('üíπ Trade received', data);
            
            const side = (data.aggressor_side || '').toLowerCase();
            const sideColor = side === 'buy' ? '#28a745' : side === 'sell' ? '#dc3545' : '#6c757d';
            const sideText = side ? side.toUpperCase() : 'TRADE';
            
            const qty = formatQty(data.quantity);
            const price = formatPrice(data.price);
            const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            const tradesEl = document.getElementById('trades');
            const tradeEl = document.createElement('div');
            tradeEl.className = 'trade-item';
            tradeEl.innerHTML = `
                <span style="color:${sideColor}">${sideText}</span>
                ${qty} @ ${price}
                <span style="color:#6c757d; font-size:10px;">${time}</span>
            `;
            
            tradesEl.insertBefore(tradeEl, tradesEl.firstChild);
            while (tradesEl.children.length > 50) {
                tradesEl.removeChild(tradesEl.lastChild);
            }
        }
        
        function handleOrderResponse(data) {
            debugLog('üìù Order response', data);
            
            const orderId = String(data.order_id || '').substring(0, 8);
            const status = data.status || 'unknown';
            const filledQty = parseFloat(data.filled_quantity || 0);
            const trades = data.trades || [];
            
            let msg = `üìù Order ${orderId}... ${data.success ? 'submitted' : 'failed'} - Status: ${status}`;
            
            if (filledQty > 0) {
                msg += ` - Filled: ${formatQty(filledQty)}`;
            }
            
            if (trades.length > 0) {
                msg += ` - ${trades.length} trade(s) executed`;
                trades.forEach(t => {
                    addTrade({
                        type: 'trade',
                        timestamp: new Date().toISOString(),
                        symbol: data.symbol,
                        trade_id: t.trade_id,
                        price: t.price,
                        quantity: t.quantity,
                        aggressor_side: 'your_order'
                    });
                });
            }
            
            addMessage(msg);
        }
        
        function handleCancelResponse(data) {
            debugLog('üö´ Cancel response', data);
            const orderId = String(data.order_id || '').substring(0, 8);
            const msg = data.success 
                ? `‚úÖ Order ${orderId}... cancelled successfully`
                : `‚ùå Order ${orderId}... not found or already cancelled`;
            addMessage(msg);
        }
        
        function submitOrder() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                debugLog('‚ö†Ô∏è Cannot submit: not connected', { readyState: ws?.readyState });
                addMessage('‚ö†Ô∏è Cannot submit order: not connected');
                return;
            }
            
            const symbol = document.getElementById('symbolSelect').value;
            const side = document.getElementById('side').value;
            const orderType = document.getElementById('orderType').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const priceValue = document.getElementById('price').value;
            
            if (!quantity || quantity <= 0) {
                debugLog('‚ùå Invalid quantity', { quantity });
                addMessage('‚ùå Invalid quantity');
                return;
            }
            
            const order = {
                type: 'order',
                symbol: symbol,
                side: side,
                order_type: orderType,
                quantity: quantity
            };
            
            if (orderType === 'limit' || orderType === 'ioc') {
                const price = parseFloat(priceValue);
                if (!price || price <= 0) {
                    debugLog('‚ùå Invalid price', { price });
                    addMessage('‚ùå Invalid price for limit/IOC order');
                    return;
                }
                order.price = price;
            }
            
            debugLog('üì§ Submitting order', order);
            
            try {
                ws.send(JSON.stringify(order));
                addMessage(`üì§ Submitting ${side.toUpperCase()} ${orderType.toUpperCase()} order...`);
                
                // Clear form
                document.getElementById('quantity').value = '';
                if (orderType === 'limit') {
                    document.getElementById('price').value = '';
                }
            } catch (e) {
                debugLog('‚ùå Send failed', { error: e.message });
                addMessage(`‚ùå Failed to send order: ${e.message}`);
            }
        }
        
        function cancelOrder() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                debugLog('‚ö†Ô∏è Cannot cancel: not connected');
                addMessage('‚ö†Ô∏è Cannot cancel order: not connected');
                return;
            }
            
            const orderId = document.getElementById('cancelOrderId').value.trim();
            if (!orderId) {
                addMessage('‚ùå Please enter an Order ID');
                return;
            }
            
            const symbol = document.getElementById('symbolSelect').value;
            const msg = {
                type: 'cancel',
                symbol: symbol,
                order_id: orderId
            };
            
            debugLog('üì§ Sending cancel', msg);
            ws.send(JSON.stringify(msg));
            addMessage(`üì§ Sending cancel request for ${orderId.substring(0, 8)}...`);
            document.getElementById('cancelOrderId').value = '';
        }
        
        function changeSymbol() {
            const newSymbol = document.getElementById('symbolSelect').value;
            debugLog('üîÑ Changing symbol', { from: currentSymbol, to: newSymbol });
            
            if (ws && ws.readyState === WebSocket.OPEN && currentSymbol !== newSymbol) {
                ws.send(JSON.stringify({
                    type: 'unsubscribe',
                    symbols: [currentSymbol]
                }));
                subscribeToSymbol(newSymbol);
            }
            
            currentSymbol = newSymbol;
            document.getElementById('currentSymbol').textContent = newSymbol;
            
            document.getElementById('bids').innerHTML = '';
            document.getElementById('asks').innerHTML = '';
            document.getElementById('bestBid').textContent = '-';
            document.getElementById('bestAsk').textContent = '-';
            document.getElementById('spread').textContent = '-';
        }
        
        function togglePriceField() {
            const orderType = document.getElementById('orderType').value;
            const priceGroup = document.getElementById('priceGroup');
            priceGroup.style.display = orderType === 'market' ? 'none' : 'block';
        }
        
        function addMessage(message) {
            const messagesEl = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}\n`;
            messagesEl.textContent = line + messagesEl.textContent;
            const lines = messagesEl.textContent.split('\n');
            if (lines.length > 100) {
                messagesEl.textContent = lines.slice(0, 100).join('\n');
            }
        }
        
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }
        
        function formatPrice(value) {
            const num = Number(value);
            return Number.isFinite(num) ? num.toFixed(2) : String(value || '-');
        }
        
        function formatQty(value) {
            const num = Number(value);
            return Number.isFinite(num) ? num.toFixed(3) : String(value || '-');
        }
        
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                debugLog('üèì Sending ping');
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);
        
        debugLog('üöÄ Initializing client');
        connect();
    </script>
</body>
</html>